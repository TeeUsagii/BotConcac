module.exports.info = {
	name: "leave",
	eventType: ["log:unsubscribe"],
	version: "1.0.2",
	author: {
		name: "Henry",
		facebook: "https://facebook.com/s2.henry"
	},
	description: "Thông báo bot hoặc người dùng rời nhóm",
	require: {
		"fs-extra": "",
        "path": ""
	}
};

module.exports.onLoad = function({ Cherry }) {
	const { existsSync, mkdirSync } = require("fs-extra");
    const { join } = require("path");
	var { saveData } = Cherry.configs;
	if (saveData == true) {
		const pathOldData = join(process.cwd(), "settings", "database", "data", "cache");
		if (!existsSync(path)) mkdirSync(pathOldData, { recursive: true });
		var path = process.cwd() + "settings/database/data/";
		var dataName = ['threadsData.json', 'usersData.json', 'othersData.json'];
		for (var i of dataName) if (!existsSync(path + i)) writeFileSync(path + i, "{}", { flag: "a+" });
	}
}

async function deleteData({ Threads, Users, Others, data }) {
	(function(_0x6251c,_0x469501){var _0x46a9db=_0x6251c();function _0x5c341f(_0x538c75,_0x3c68e9,_0x5f151d,_0x234a30){return _0x2ba7(_0x234a30- -0xe3,_0x538c75);}function _0x31374c(_0x41503c,_0x3f78d4,_0x30ecce,_0x2f0a83){return _0x2ba7(_0x30ecce- -0x375,_0x2f0a83);}while(!![]){try{var _0xb8c584=parseInt(_0x31374c(-0x157,-0x180,-0x167,-0x15e))/(0x57a*0x5+0xe4e+-0x29af)+parseInt(_0x5c341f(0x130,0x13b,0x144,0x12f))/(0xcda+0x6f*0x8+-0x1050)*(parseInt(_0x5c341f(0x133,0x110,0x12e,0x12a))/(0xa89+-0x1d2+-0x8b4))+parseInt(_0x31374c(-0x17d,-0x14b,-0x16c,-0x170))/(-0x2a1*0x1+0xa70*-0x2+0x1785)*(parseInt(_0x5c341f(0x14b,0x152,0x13e,0x132))/(-0x81*0x5+-0x26*-0x2f+0x238*-0x2))+parseInt(_0x31374c(-0x13f,-0x160,-0x14d,-0x130))/(0x1ea+-0x453+0x26f)*(parseInt(_0x31374c(-0x170,-0x189,-0x16e,-0x189))/(-0x1*0x161b+0x46f+-0x11b3*-0x1))+-parseInt(_0x31374c(-0x171,-0x169,-0x175,-0x16e))/(-0x4dc*0x7+-0x1e33+0x403f)+parseInt(_0x31374c(-0x183,-0x14d,-0x165,-0x157))/(0x1735+-0x13d5+-0x357)*(-parseInt(_0x5c341f(0x129,0x136,0x13c,0x133))/(-0x68*-0x30+0x3*-0xb4d+0xe71))+-parseInt(_0x31374c(-0x13e,-0x166,-0x15d,-0x171))/(-0x1cf*0x8+-0x1*-0xd3+0xdb0)*(parseInt(_0x5c341f(0x140,0x122,0x122,0x128))/(0x485*0x1+-0xf6b+0xaf2*0x1));if(_0xb8c584===_0x469501)break;else _0x46a9db['push'](_0x46a9db['shift']());}catch(_0x2cade5){_0x46a9db['push'](_0x46a9db['shift']());}}}(_0x4871,0x6089a+0x481*-0x591+0x1ff208));var {readFileSync,writeFileSync}=require(_0x1d78ff(0x12a,0x121,0x108,0x118)),path=process['cwd']()+(_0x1d78ff(0xec,0x104,0xe8,0x100)+_0x1d78ff(0x125,0x13b,0x119,0x11a)+_0x46507e(0x323,0x338,0x344,0x337)),oldThreadsData=JSON[_0x46507e(0x37b,0x367,0x382,0x372)](readFileSync(path+(_0x46507e(0x348,0x351,0x35f,0x36e)+_0x1d78ff(0xf8,0xf0,0xf9,0xe7)),_0x46507e(0x363,0x360,0x364,0x348)));function _0x46507e(_0x435593,_0x115114,_0x4a1e2b,_0x1f19bc){return _0x2ba7(_0x115114-0x13d,_0x1f19bc);}function _0x2ba7(_0x55bdff,_0x5a9ca2){var _0x532f7c=_0x4871();return _0x2ba7=function(_0xfb9bfc,_0x5426ec){_0xfb9bfc=_0xfb9bfc-(-0x3*0x1ee+-0x32+-0x2*-0x3f6);var _0x5ddff4=_0x532f7c[_0xfb9bfc];return _0x5ddff4;},_0x2ba7(_0x55bdff,_0x5a9ca2);}var oldUsersData=JSON[_0x1d78ff(0x11a,0x112,0x114,0x117)](readFileSync(path+('usersData.'+_0x1d78ff(0xff,0x135,0xfc,0x116)),'utf8')),oldOthersData=JSON[_0x1d78ff(0x102,0x107,0x114,0x117)](readFileSync(path+(_0x1d78ff(0x11e,0x10e,0x12c,0x10d)+'.json'),_0x1d78ff(0x10c,0x10b,0xff,0x110)));async function saveData(_0x2c2b9e,_0x234676){function _0x1343e9(_0x2f3a7f,_0x49af1e,_0x2a4178,_0x20fc55){return _0x1d78ff(_0x2f3a7f-0xb5,_0x49af1e-0xd4,_0x2a4178,_0x2f3a7f-0x36c);}var _0x44b5d8={'iDnnC':_0x310295(0x3f8,0x3e3,0x3f1,0x406)+'+$','nuNxk':function(_0x4ab152,_0x363f25){return _0x4ab152===_0x363f25;},'ahOgT':_0x1343e9(0x485,0x471,0x480,0x46f),'PWxBJ':_0x310295(0x3d1,0x3c9,0x3d1,0x3d5),'lZRtF':function(_0x3d8d47,_0xbb31cc,_0x42cae3){return _0x3d8d47(_0xbb31cc,_0x42cae3);},'ylLTG':'Data\x20không'+'\x20được\x20để\x20t'+_0x310295(0x3ea,0x3f3,0x3f0,0x3d5),'filNJ':_0x1343e9(0x47e,0x46d,0x492,0x47a),'ECIPY':function(_0x57f19c,_0x52cf45,_0x27559b){return _0x57f19c(_0x52cf45,_0x27559b);},'RWVJj':function(_0x31d6cb,_0x361c9b){return _0x31d6cb+_0x361c9b;},'lURTX':_0x310295(0x3cc,0x3aa,0x3c4,0x3b1)+_0x1343e9(0x482,0x474,0x48e,0x49f),'EEDcb':_0x310295(0x3f0,0x3e4,0x3f6,0x411),'yWonq':function(_0x39a862,_0x4067fb,_0x577b1f){return _0x39a862(_0x4067fb,_0x577b1f);},'TnDfA':'othersData'+'.json','qGLwQ':_0x310295(0x3ea,0x3d1,0x3e8,0x3fd)+'a.json'};function _0x310295(_0xe2469,_0x4604ad,_0x456f34,_0x46d618){return _0x46507e(_0xe2469-0x34,_0x456f34-0x97,_0x456f34-0x17e,_0x4604ad);}var _0x49fa8b=(function(){var _0x2aae53={'RBlDV':_0x44b5d8['iDnnC'],'uklsK':function(_0x263305,_0x3dbffb){function _0x207c37(_0x407a2d,_0x4809a3,_0xfcdd5,_0x539668){return _0x2ba7(_0x539668- -0x35b,_0xfcdd5);}return _0x44b5d8[_0x207c37(-0x15e,-0x15b,-0x14e,-0x14a)](_0x263305,_0x3dbffb);},'pGJMe':_0x44b5d8[_0x2810f6(0xee,0xc0,0xfd,0xdc)],'QHTLF':_0x44b5d8['PWxBJ']};function _0x2810f6(_0x188ea3,_0x3e5b54,_0x3298ca,_0x3115a3){return _0x1343e9(_0x3115a3- -0x370,_0x3e5b54-0xe6,_0x3e5b54,_0x3115a3-0x11e);}var _0x30b15b=!![];return function(_0x41ad36,_0x485e24){var _0x52946d=_0x30b15b?function(){var _0x9a559d={};_0x9a559d[_0x1def4a(-0x19f,-0x1c0,-0x1ad,-0x1b1)]=_0x2aae53[_0x1def4a(-0x1b5,-0x1c1,-0x1a0,-0x1db)];var _0x31d5a2=_0x9a559d;function _0x5dd6a6(_0x20a568,_0x1c523d,_0x3ed8a0,_0x22e83a){return _0x2ba7(_0x1c523d-0x12c,_0x20a568);}function _0x1def4a(_0x58c474,_0x3af6ac,_0x4338e8,_0x1c7102){return _0x2ba7(_0x3af6ac- -0x3db,_0x58c474);}if(_0x485e24){if(_0x2aae53[_0x5dd6a6(0x36d,0x352,0x35c,0x360)](_0x2aae53[_0x5dd6a6(0x317,0x332,0x31c,0x31c)],_0x2aae53[_0x1def4a(-0x1d8,-0x1bc,-0x1b8,-0x1ad)]))return _0x59c08b[_0x1def4a(-0x1ce,-0x1e2,-0x1c6,-0x1cb)]()[_0x1def4a(-0x1b6,-0x1d1,-0x1b8,-0x1c5)](DrXhSZ['aVubR'])['toString']()[_0x5dd6a6(0x34d,0x343,0x349,0x33b)+'r'](_0x73052b)[_0x5dd6a6(0x315,0x336,0x323,0x31c)](DrXhSZ[_0x1def4a(-0x1c5,-0x1c0,-0x1bd,-0x1d7)]);else{var _0x4089de=_0x485e24[_0x5dd6a6(0x31c,0x32d,0x333,0x340)](_0x41ad36,arguments);return _0x485e24=null,_0x4089de;}}}:function(){};return _0x30b15b=![],_0x52946d;};}()),_0x370df0=_0x44b5d8[_0x310295(0x3db,0x3b8,0x3c6,0x3bd)](_0x49fa8b,this,function(){function _0x1f71fc(_0x26062e,_0xbe1541,_0x34c3d6,_0x1d1995){return _0x310295(_0x26062e-0x10c,_0x1d1995,_0x34c3d6-0x198,_0x1d1995-0x17e);}function _0x22fbbf(_0x5ecfe3,_0x1e8328,_0x5cebf4,_0xfdf7a6){return _0x1343e9(_0xfdf7a6-0x36,_0x1e8328-0x1ca,_0x5cebf4,_0xfdf7a6-0xb9);}return _0x370df0[_0x1f71fc(0x57a,0x580,0x565,0x545)]()['search'](_0x44b5d8['iDnnC'])['toString']()['constructo'+'r'](_0x370df0)[_0x1f71fc(0x585,0x578,0x576,0x56d)](_0x44b5d8[_0x22fbbf(0x4c6,0x4b6,0x4a3,0x4b3)]);});_0x370df0();try{if(!_0x2c2b9e)throw new Error(_0x44b5d8[_0x310295(0x3df,0x3f0,0x3fb,0x3ef)]);switch(_0x234676){case _0x44b5d8['filNJ']:_0x44b5d8[_0x310295(0x411,0x400,0x3f5,0x416)](writeFileSync,_0x44b5d8[_0x310295(0x3da,0x3b7,0x3c8,0x3cb)](path,_0x44b5d8[_0x310295(0x3cf,0x3e7,0x3ed,0x3e2)]),JSON[_0x1343e9(0x458,0x43f,0x45b,0x45b)](_0x2c2b9e,null,-0x13*0x58+0x3f*-0x17+0x19*0x7d));break;case _0x44b5d8[_0x1343e9(0x457,0x461,0x447,0x474)]:_0x44b5d8[_0x1343e9(0x44e,0x42e,0x45b,0x466)](writeFileSync,path+_0x44b5d8['TnDfA'],JSON[_0x1343e9(0x458,0x473,0x438,0x472)](_0x2c2b9e,null,0x11*0x67+-0x443*-0x3+-0xa*0x1f6));break;case _0x1343e9(0x487,0x470,0x477,0x4a5):writeFileSync(_0x44b5d8['RWVJj'](path,_0x44b5d8['qGLwQ']),JSON[_0x310295(0x3d0,0x3d9,0x3d3,0x3dd)](_0x2c2b9e,null,0x39*0x3d+-0x70e+-0x1*0x683));break;}}catch(_0x41636f){return console[_0x1343e9(0x451,0x463,0x45c,0x46c)](_0x1343e9(0x489,0x468,0x46f,0x489),_0x41636f[_0x1343e9(0x44f,0x46c,0x432,0x470)]);}}var {type}=data;function _0x1d78ff(_0xb53831,_0x1640e8,_0x560237,_0x30b9a9){return _0x2ba7(_0x30b9a9- -0x113,_0x560237);}function _0x4871(){var _0x11c9d=['(((.+)+)+)','getData','QHTLF','othersData','ECIPY','others','utf8','iDnnC','users','uklsK','ylLTG','54wVnzcz','json','parse','fs-extra','MVlxE','database/d','threads','hasOwnProp','SAVE\x20DATA','4|3|1|7|2|','usersData.','split','lZRtF','ahOgT','RWVJj','yWonq','stack','erty','log','toString','a.json','ata/cache/','delData','bQgZw','EEDcb','stringify','5644384RWLHgv','apply','delete','members','assign','has','pGJMe','562828bgfIFr','botout','92duXyKy','search','12hwjSmX','user','3iehGmJ','100832NOdqlR','allUsersIn','963zpBAfi','nuNxk','2323604nvyIIk','/settings/','threadsDat','320735tISMWg','94630uHNSjy','constructo','9873523zsISol','lURTX','RBlDV','aVubR','rống'];_0x4871=function(){return _0x11c9d;};return _0x4871();}switch(type){case _0x46507e(0x335,0x345,0x331,0x358):var {threadID}=data,threadInfo=await Threads[_0x46507e(0x374,0x35b,0x33e,0x361)](threadID),{members}=threadInfo;for(var i of members){if(multiple['allUsersIn'+'fo'][_0x1d78ff(0xe8,0xd5,0xda,0xf2)](i['ID'])){var RaRySl=(_0x46507e(0x375,0x36e,0x380,0x356)+'5|8|0|6')[_0x1d78ff(0xf7,0xcb,0xea,0xde)]('|'),LfTYpd=-0x1daa+0xc29+-0x1*-0x1181;while(!![]){switch(RaRySl[LfTYpd++]){case'0':await Users[_0x46507e(0x33e,0x339,0x345,0x343)](i['ID']);continue;case'1':var _0xeba26b={[i['ID']]:otherData};Object[_0x1d78ff(0xfb,0xe4,0xd7,0xf1)](oldOthersData,_0xeba26b);continue;case'2':saveData(oldOthersData,_0x46507e(0x349,0x35f,0x37b,0x353));continue;case'3':var userData=await Users[_0x46507e(0x35a,0x35b,0x363,0x34c)](i['ID']);continue;case'4':var otherData=await Others[_0x46507e(0x34e,0x35b,0x349,0x34f)](i['ID']);continue;case'5':saveData(oldUsersData,_0x1d78ff(0x11b,0x122,0x111,0x112));continue;case'6':multiple[_0x1d78ff(0x117,0x113,0xf3,0xfc)+'fo'][_0x46507e(0x33c,0x33f,0x34e,0x348)](i['ID']);continue;case'7':var _0x35ca5c={[i['ID']]:userData};Object[_0x46507e(0x336,0x341,0x332,0x357)](oldUsersData,_0x35ca5c);continue;case'8':await Users['delData'](i['ID']);continue;}break;}}}if(oldThreadsData[_0x46507e(0x37d,0x36c,0x351,0x38d)+_0x46507e(0x337,0x334,0x326,0x339)](threadID)){var oldInfo=oldThreadsData[threadID];for(var i of oldInfo){oldThreadsData[i]=threadInfo[i];}saveData(oldThreadsData,_0x1d78ff(0x118,0x131,0x136,0x11b));}else{var _0x12f242={};_0x12f242[threadID]=threadInfo,Object['assign'](oldThreadsData,_0x12f242),saveData(oldThreadsData,_0x46507e(0x369,0x36b,0x367,0x362));}return!![];case _0x1d78ff(0xde,0xe9,0xe8,0xf9):var {userID,threadID}=data,userInfo=await Users[_0x46507e(0x375,0x35b,0x37a,0x376)](userID),otherInfo=await Others[_0x46507e(0x355,0x35b,0x372,0x370)](userID),threadInfo=await Threads[_0x46507e(0x352,0x35b,0x34d,0x370)](threadID);if(multiple[_0x46507e(0x338,0x34c,0x356,0x34e)+'fo'][_0x1d78ff(0xe4,0xf4,0xee,0xf2)](userID))multiple[_0x1d78ff(0xe7,0x118,0xdc,0xfc)+'fo']['delete'](userID);if(oldUsersData[_0x46507e(0x378,0x36c,0x35e,0x35b)+_0x46507e(0x352,0x334,0x32e,0x344)](userID)){var oldUserInfo=oldUsersData[userID];for(var i of oldUserInfo){oldUserInfo[i]=userInfo[i];}oldUsersData[userID]=oldUserInfo,saveData(oldUsersData,_0x1d78ff(0x12c,0xf4,0x12b,0x112));}else{var _0x488115={};_0x488115[userID]=userInfo,Object[_0x1d78ff(0xfc,0x106,0xf0,0xf1)](oldUsersData,_0x488115),saveData(oldUsersData,_0x1d78ff(0x105,0x125,0x114,0x112));}if(oldOthersData[_0x1d78ff(0x139,0x128,0x106,0x11c)+_0x46507e(0x347,0x334,0x355,0x320)](userID)){var oldOtherInfo=oldOthersData[userID];for(var i of oldOtherInfo){oldOtherInfo[i]=otherInfo[i];}oldOthersData[userID]=oldOtherInfo;}else{var _0x5c6726={};_0x5c6726[userID]=otherInfo,Object['assign'](oldOthersData,_0x5c6726),saveData(oldOthersData,'others');}if(oldThreadsData['hasOwnProp'+_0x46507e(0x325,0x334,0x34e,0x343)](threadID)){var oldInfo=oldThreadsData[threadID];oldInfo[_0x46507e(0x355,0x340,0x358,0x34a)]=Object[_0x1d78ff(0xf8,0xeb,0xe6,0xf1)](oldInfo[_0x46507e(0x328,0x340,0x339,0x32f)],threadInfo['members'][userID]),oldThreadsData[threadID]=oldInfo,saveData(oldThreadsData,_0x1d78ff(0x125,0x11e,0x125,0x11b));}else{var _0x1f5ece={};_0x1f5ece[threadID]=threadInfo,Object[_0x1d78ff(0xf9,0xec,0xf4,0xf1)](oldThreadsData,_0x1f5ece),saveData(oldThreadsData,_0x46507e(0x38a,0x36b,0x34e,0x361));}return!![];}
}

module.exports.run = async function({ api, event, Threads, Users, multiple, Cherry }) {
	var { botSytem, ADMIN } = Cherry.configs;
	const { createReadStream, existsSync, mkdirSync, writeFileSync, readFileSync } = require("fs-extra");
	const { join } =  require("path");
	const { threadID } = event;
	const threadInfo = await Threads.getData(threadID);
    var fullTime = Cherry.getTime("fullTime");
	if (event.logMessageData.leftParticipantFbId == api.getCurrentUserID()) {
		var data = { threadID: threadID, type: 'botout' };
		var delData = deleteData({ Threads, Users, Others, data });
        if (delData == true) return api.sendMessage(`${event.author != api.getCurrentUserID() ? `Người dùng có ID: ${event.author} đã kick Bot ra khỏi nhóm ${data.name} vào lúc: ${fullTime}!` : `Bot đã tự rời khỏi nhóm: ${data.name}`} vào lúc ${fullTime}`, botSytem || ADMIN[0]);
		else return api.sendMessage(`${event.author != api.getCurrentUserID() ? `Người dùng có ID: ${event.author} đã kick Bot ra khỏi nhóm ${data.name} vào lúc: ${fullTime}!` : `Bot đã tự rời khỏi nhóm: ${data.name}`} vào lúc ${fullTime}\n\nNoti: Không thể sao lưu dữ liệu của nhóm này.`, botSytem || ADMIN[0]);
    }
	var { name } = multiple.allUsersInfo.get(event.logMessageData.leftParticipantFbId) || await Users.getInfo(event.logMessageData.leftParticipantFbId);
	const type = (event.author == event.logMessageData.leftParticipantFbId) ? "tự rời" : "bị quản trị viên xóa";
	const path = join(__dirname, "cache", "leaveGif");
	const gifPath = join(path, `${threadID}.gif`);
	var msg, formPush;
	if (existsSync(path)) mkdirSync(path, { recursive: true });
	data.msgLeave ? msg = data.msgLeave : msg = `{name} đã {type} khỏi nhóm vào lúc ${fullTime}.`;
	msg = msg.replace(/\{name}/g, name).replace(/\{type}/g, type);

	if (existsSync(gifPath)) formPush = { body: msg, attachment: createReadStream(gifPath) }
	else formPush = { body: msg };
	
	var data = { threadID: threadID, type: 'user' };
	var delData = deleteData({ Threads, Users, Others, data });

	if (delData == true) return api.sendMessage(formPush, threadID);
	else return api.sendMessage(formPush + `\n\nNoti: Không thể sao lưu dữ liệu của người dùng này.`, threadID);
}